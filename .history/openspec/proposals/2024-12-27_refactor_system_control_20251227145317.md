# Refactoring Proposal: system_control.c

**Date**: 2024-12-27  
**Author**: AI Assistant  
**Status**: Draft - Pending User Review

---

## 1. Current State Analysis

### 1.1 File Statistics
| Metric | Value |
|--------|-------|
| Total Lines | 4694 |
| Total Functions | 52 |
| Average Lines/Function | ~90 |
| Largest Function | System_Pressure_Balance_Function (~220 lines) |

### 1.2 Function Inventory (Grouped by Responsibility)

#### A. 点火控制 (Ignition Control) - 4 functions
| Function | Lines | Description |
|----------|-------|-------------|
| `Before_Ignition_Prepare()` | ~100 | 点火前准备 |
| `Sys_Ignition_Fun()` | ~540 | 点火主流程 |
| `Ignition_Check_Fun()` | ~35 | 点火检测 |
| `Sys_Launch_Function()` | ~75 | 启动流程 |

#### B. 压力控制 (Pressure Control) - 3 functions
| Function | Lines | Description |
|----------|-------|-------------|
| `System_Pressure_Balance_Function()` | ~220 | 单机压力平衡 |
| `XB_System_Pressure_Balance_Function()` | ~210 | 相变压力平衡 |
| `Speed_Pressure_Function()` | ~60 | 风机压力控制 |

#### C. 水位控制 (Water Control) - 8 functions
| Function | Lines | Description |
|----------|-------|-------------|
| `Water_Balance_Function()` | ~140 | 单机补水平衡 |
| `Water_BianPin_Function()` | ~186 | 单机变频补水 |
| `ShuangPin_Water_Balance_Function()` | ~135 | 双拼补水平衡 |
| `Double_Water_BianPin_Function()` | ~200 | 双拼变频补水 |
| `Double_WaterPump_LogicFunction()` | ~170 | 双水泵逻辑 |
| `Special_Water_Supply_Function()` | ~48 | 特殊补水 |
| `WaterLevel_Unchange_Check()` | ~32 | 水位无变化检测 |
| `Last_Blow_Start_Fun()` / `Last_Blow_End_Fun()` | ~45 | 后吹控制 |

#### D. 故障/异常处理 (Error Handling) - 6 functions
| Function | Lines | Description |
|----------|-------|-------------|
| `Auto_Check_Fun()` | ~110 | 运行中自检 |
| `Abnormal_Check_Fun()` | ~45 | 异常检测 |
| `Abnormal_Events_Response()` | ~255 | 异常事件响应 |
| `Err_Response()` | ~75 | 故障响应(运行中) |
| `IDLE_Err_Response()` | ~85 | 故障响应(待机) |
| `Lcd_Err_Refresh()` / `Lcd_Err_Read()` | ~14 | LCD故障刷新 |

#### E. 排污控制 (Blowdown Control) - 4 functions
| Function | Lines | Description |
|----------|-------|-------------|
| `Auto_Pai_Wu_Function()` | ~130 | 自动排污 |
| `YunXingZhong_TimeAdjustable_PaiWu_Function()` | ~12 | 运行中可调排污 |
| `PaiWu_Warnning_Function()` | ~66 | 排污警告 |
| `LianXu_Paiwu_Control_Function()` | ~100 | 连续排污控制 |

#### F. 启停控制 (Start/Stop Control) - 4 functions
| Function | Lines | Description |
|----------|-------|-------------|
| `sys_start_cmd()` | ~70 | 系统启动命令 |
| `sys_close_cmd()` | ~55 | 系统关闭命令 |
| `Auto_StartOrClose_Process_Function()` | ~10 | 自动启停流程 |
| `GetOut_Mannual_Function()` | ~17 | 退出手动模式 |

#### G. IO/输入处理 (IO Processing) - 2 functions
| Function | Lines | Description |
|----------|-------|-------------|
| `Get_IO_Inf()` | ~125 | 获取IO信息 |
| `byte_to_bit()` | ~23 | 字节转位 |

#### H. 待机状态 (Idle State) - 3 functions
| Function | Lines | Description |
|----------|-------|-------------|
| `Idel_Check_Fun()` | ~40 | 待机检测 |
| `System_Idel_Function()` | ~13 | 待机功能 |
| `IDLE_Auto_Pai_Wu_Function()` | ~7 | 待机自动排污 |

#### I. 配置/时间管理 (Config/Time) - 5 functions
| Function | Lines | Description |
|----------|-------|-------------|
| `sys_work_time_function()` | ~62 | 工作时间统计 |
| `Admin_Work_Time_Function()` | ~63 | 管理员工作时间 |
| `Check_Config_Data_Function()` | ~153 | 配置数据检查 |
| `sys_control_config_function()` | ~240 | 系统配置功能 |
| `One_Sec_Check()` | ~55 | 一秒检测 |

#### J. 其他 (Miscellaneous) - 13 functions
| Function | Lines | Description |
|----------|-------|-------------|
| `System_All_Control()` | ~190 | 总控制入口 |
| `copy_to_lcd()` | ~9 | 复制数据到LCD |
| `Load_LCD_Data()` | ~9 | 加载LCD数据 |
| `clear_struct_memory()` | ~29 | 清空结构体 |
| `Manual_Realys_Function()` | ~12 | 手动继电器 |
| `HardWare_Protect_Relays_Function()` | ~7 | 硬件保护继电器 |
| `Power_ON_Begin_Check_Function()` | ~10 | 上电初始检测 |
| `Fan_Speed_Check_Function()` | ~47 | 风机速度检测 |
| `Wifi_Lock_Time_Function()` | ~49 | WiFi锁定时间 |
| `XiangBian_Steam_AddFunction()` | ~152 | 相变蒸汽追加 |
| `JTAG_Diable()` | ~11 | 禁用JTAG |

---

## 2. Proposed Module Split

### 2.1 New Module Structure

```
SYSTEM/
├── system_control/
│   ├── system_control.c      # 主控制入口 (精简版, ~300 lines)
│   └── system_control.h      # 主头文件 (保留现有结构体定义)
├── ignition/
│   ├── ignition_ctrl.c       # 点火控制 (~400 lines)
│   └── ignition_ctrl.h
├── pressure/
│   ├── pressure_ctrl.c       # 压力平衡控制 (~350 lines)
│   └── pressure_ctrl.h
├── water/
│   ├── water_ctrl.c          # 水位控制 (~500 lines)
│   └── water_ctrl.h
├── error/
│   ├── error_handler.c       # 故障处理 (~400 lines)
│   └── error_handler.h
├── blowdown/
│   ├── blowdown_ctrl.c       # 排污控制 (~250 lines)
│   └── blowdown_ctrl.h
└── config/
    ├── sys_config.c          # 配置管理 (~350 lines)
    └── sys_config.h
```

### 2.2 Module Responsibilities

| Module | Functions to Include | Est. Lines |
|--------|---------------------|------------|
| **system_control** | `System_All_Control()`, state machine, `sys_start_cmd()`, `sys_close_cmd()` | ~300 |
| **ignition** | `Before_Ignition_Prepare()`, `Sys_Ignition_Fun()`, `Ignition_Check_Fun()`, `Sys_Launch_Function()` | ~400 |
| **pressure** | `System_Pressure_Balance_Function()`, `XB_System_Pressure_Balance_Function()`, `Speed_Pressure_Function()` | ~350 |
| **water** | All water-related functions | ~500 |
| **error** | `Auto_Check_Fun()`, `Abnormal_*`, `Err_Response()`, `IDLE_Err_Response()` | ~400 |
| **blowdown** | All `Pai_Wu` functions, `Last_Blow_*` | ~250 |
| **config** | `sys_control_config_function()`, `Check_Config_Data_Function()`, time functions | ~350 |

### 2.3 Shared Data Strategy

保留 `system_control.h` 作为全局数据结构定义文件：
- `sys_data`, `sys_flag`, `sys_config_data`, `Sys_Admin` 等结构体
- 各模块通过 `extern` 引用这些全局变量
- 逐步将模块内部状态迁移到模块私有 `static` 变量

---

## 3. Implementation Plan

### Phase 1: 准备工作 (Low Risk)
1. 创建新模块目录结构
2. 创建头文件，定义接口
3. 添加到 Keil 工程

### Phase 2: 提取 error_handler 模块 (Medium Risk)
- 最独立的模块，耦合最少
- 包含故障检测和响应逻辑
- 验证：触发各种故障，确认行为一致

### Phase 3: 提取 blowdown_ctrl 模块 (Low Risk)
- 排污逻辑相对独立
- 验证：测试排污流程

### Phase 4: 提取 config 模块 (Low Risk)
- 配置相关函数
- 验证：参数修改、保存、加载

### Phase 5: 提取 water_ctrl 模块 (High Risk)
- 水位控制涉及安全
- 需要仔细测试单机、双拼、变频等所有模式
- 验证：长时间运行测试

### Phase 6: 提取 pressure_ctrl 模块 (High Risk)
- 压力控制涉及安全
- 验证：压力追踪、负载变化响应

### Phase 7: 提取 ignition_ctrl 模块 (High Risk)
- 点火流程复杂，状态机嵌套
- 验证：冷启动、热启动、点火失败重试

### Phase 8: 精简 system_control (Final)
- 只保留状态机骨架和模块调度
- 验证：完整功能回归测试

---

## 4. Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| 引入新bug | Medium | High | 每个模块独立验证，保留旧代码备份 |
| 中断/定时问题 | Low | High | 保持 `volatile` 标记，不修改中断代码 |
| 编译错误 | High | Low | 分阶段编译验证 |
| 功能遗漏 | Medium | Medium | 对照函数清单逐一确认 |

---

## 5. Acceptance Criteria

- [ ] 所有52个函数都有明确归属模块
- [ ] 每个模块 < 500 行
- [ ] 编译无错误、无警告
- [ ] 所有原有功能正常工作
- [ ] 主从机通信正常
- [ ] 故障检测和响应正常
- [ ] 点火流程正常
- [ ] 水位控制正常

---

## 6. Next Steps

1. **用户确认**：请确认模块划分是否合理
2. **优先级确认**：从哪个模块开始？建议从 `error_handler` 开始（风险最低）
3. **开始实施**：创建第一个模块

---

**请确认此提案，或提出修改意见。**

