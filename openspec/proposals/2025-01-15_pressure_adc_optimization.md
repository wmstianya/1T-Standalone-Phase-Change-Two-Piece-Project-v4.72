# 变更提案：压力变送器ADC采集优化

| 字段 | 值 |
|------|-----|
| **提案编号** | 2025-01-15_pressure_adc_optimization |
| **创建日期** | 2025-01-15 |
| **状态** | 实施中 |
| **影响范围** | `HARDWARE/ADC/bsp_adc.c`, `HARDWARE/ADC/bsp_adc.h` |

---

## 1. 背景与问题

### 1.1 当前问题

1. **采样电阻参数错误**：代码中使用559mV作为4mA零点，对应约140Ω电阻；但实际采样电阻为**100Ω**，4mA应对应**400mV**
2. **滤波效果差**：当前使用5点简单平均滤波，滤波深度不够，无法有效去除干扰
3. **无自校准功能**：不同设备存在零点漂移，无法现场校准

### 1.2 硬件参数

| 参数 | 值 |
|------|-----|
| 采样电阻 | 100Ω (1%精度) |
| 4mA 对应电压 | 400mV |
| 20mA 对应电压 | 2000mV |
| ADC 分辨率 | 12位 (0-4095) |
| 参考电压 | 3.3V |

---

## 2. 修改方案

### 2.1 修正采样电阻参数

将零点电压从559mV修正为400mV：

```c
/* 100Ω采样电阻参数 */
#define PRESSURE_ZERO_MV      400    /* 4mA = 400mV */
#define PRESSURE_SPAN_MV      1600   /* 20mA - 4mA = 1600mV */
```

### 2.2 IIR滤波替换简单平均

采用一阶IIR低通滤波：
- 优点：计算量小（2次乘法），响应快，平滑效果好
- 滤波系数：α = 0.25（新值占25%，历史占75%）
- 时间常数：约4个采样周期

```
y[n] = (1-α) * y[n-1] + α * x[n]
     = 0.75 * y[n-1] + 0.25 * x[n]
```

### 2.3 自校准功能

支持两点校准（零点 + 满量程），校准参数存储到Flash。

---

## 3. 修改文件清单

| 文件 | 修改内容 |
|------|---------|
| `bsp_adc.c` | 修改GetVolt函数参数，新增IIR滤波函数，新增校准函数 |
| `bsp_adc.h` | 添加校准结构体定义和函数声明 |

---

## 4. 测试验证

- [ ] 零压力时显示0
- [ ] 满量程时显示正确
- [ ] 滤波后信号平稳无跳变
- [ ] 自校准功能可正常保存和加载

---

## 5. 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 参数修改导致显示不准 | 中 | 保留旧函数，新增优化版本 |
| IIR滤波响应变慢 | 低 | 系数可调，高压快速响应模式保留 |

